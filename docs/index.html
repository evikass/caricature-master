<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–®–∞—Ä–∂–ú–∞—Å—Ç–µ—Ä PRO - AI –®–∞—Ä–∂–∏</title>
    <meta name="description" content="–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —à–∞—Ä–∂–∏">
    <meta name="theme-color" content="#1e1b4b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#ec4899;--secondary:#8b5cf6;--bg:#1e1b4b;--muted:rgba(255,255,255,0.6)}
        body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#1e1b4b,#312e81,#1e1b4b);min-height:100vh;color:#fff;overflow-x:hidden}
        
        .header{position:sticky;top:0;z-index:100;background:rgba(30,27,75,0.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,0.1);padding:12px 16px}
        .header-content{display:flex;justify-content:space-between;align-items:center;max-width:500px;margin:0 auto}
        .logo{display:flex;align-items:center;gap:12px}
        .logo-icon{width:44px;height:44px;background:linear-gradient(135deg,#ec4899,#8b5cf6);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;box-shadow:0 4px 20px rgba(236,72,153,0.4)}
        .logo-text h1{font-size:1.1rem;font-weight:700}
        .badge{background:linear-gradient(135deg,#f59e0b,#d97706);padding:2px 8px;border-radius:10px;font-size:0.65rem;font-weight:600;margin-left:6px}
        .level-badge{font-size:0.75rem;color:var(--muted)}
        .level-badge span{color:#fbbf24;font-weight:600}
        .xp-display{background:rgba(255,255,255,0.1);padding:6px 14px;border-radius:20px;font-size:0.85rem}
        .xp-display span{color:#fbbf24;font-weight:700}
        .xp-bar{height:3px;background:rgba(255,255,255,0.1);margin-top:8px;border-radius:2px;overflow:hidden}
        .xp-fill{height:100%;background:linear-gradient(90deg,#fbbf24,#f59e0b);transition:width 0.5s}
        
        .main{padding-bottom:100px;max-width:500px;margin:0 auto}
        .section{padding:16px}
        .section-title{font-weight:600;font-size:0.95rem}
        .hidden{display:none!important}
        
        .upload-area{border:2px dashed rgba(255,255,255,0.3);border-radius:24px;padding:50px 20px;text-align:center;background:rgba(255,255,255,0.03);cursor:pointer;transition:all 0.3s}
        .upload-area:hover,.upload-area.dragover{border-color:var(--primary);background:rgba(236,72,153,0.08)}
        .upload-icon{width:90px;height:90px;background:linear-gradient(135deg,rgba(236,72,153,0.2),rgba(139,92,246,0.2));border-radius:24px;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-size:2.8rem;animation:float 3s ease-in-out infinite}
        @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
        .upload-title{font-size:1.5rem;font-weight:700;margin-bottom:8px}
        .upload-text{color:var(--muted);font-size:0.95rem;margin-bottom:24px}
        .btn{padding:14px 28px;border-radius:14px;font-weight:600;font-size:0.95rem;border:none;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:all 0.2s}
        .btn-primary{background:linear-gradient(135deg,#ec4899,#db2777);color:#fff;box-shadow:0 4px 20px rgba(236,72,153,0.4)}
        .btn-primary:active{transform:scale(0.96)}
        .btn-secondary{background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.2)}
        
        .preview-container{position:relative;border-radius:20px;overflow:hidden;background:rgba(0,0,0,0.3)}
        .preview-container canvas{width:100%;aspect-ratio:1;display:block}
        .preview-label{position:absolute;top:12px;left:12px;background:rgba(0,0,0,0.7);padding:6px 14px;border-radius:20px;font-size:0.8rem;z-index:10}
        .preview-close{position:absolute;top:12px;right:12px;width:40px;height:40px;background:rgba(0,0,0,0.7);border:none;border-radius:50%;color:#fff;font-size:1.3rem;cursor:pointer;z-index:10}
        
        .styles-scroll{display:flex;gap:10px;overflow-x:auto;padding-bottom:8px;scrollbar-width:none}
        .styles-scroll::-webkit-scrollbar{display:none}
        .style-card{flex-shrink:0;padding:14px 20px;border-radius:16px;border:2px solid transparent;background:rgba(255,255,255,0.05);text-align:center;cursor:pointer;transition:all 0.2s;min-width:90px}
        .style-card.active{border-color:var(--primary);background:rgba(236,72,153,0.15);box-shadow:0 4px 20px rgba(236,72,153,0.3)}
        .style-card:active{transform:scale(0.95)}
        .style-emoji{font-size:2rem;display:block;margin-bottom:4px}
        .style-name{font-size:0.8rem;font-weight:500}
        
        .slider-header{display:flex;justify-content:space-between;margin-bottom:10px}
        .slider-value{background:rgba(255,255,255,0.1);padding:4px 12px;border-radius:12px;font-size:0.85rem}
        .slider{width:100%;height:8px;border-radius:4px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none}
        .slider::-webkit-slider-thumb{-webkit-appearance:none;width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#ec4899,#8b5cf6);cursor:pointer;box-shadow:0 2px 15px rgba(236,72,153,0.5)}
        .slider-labels{display:flex;justify-content:space-between;font-size:0.75rem;color:var(--muted);margin-top:8px}
        
        .generate-btn{width:100%;padding:20px;border-radius:18px;font-weight:700;font-size:1.15rem;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all 0.3s;position:relative;overflow:hidden}
        .generate-btn:not(:disabled){background:linear-gradient(135deg,#ec4899,#8b5cf6);color:#fff;box-shadow:0 6px 35px rgba(236,72,153,0.5)}
        .generate-btn:disabled{background:rgba(255,255,255,0.1);color:var(--muted);cursor:not-allowed}
        .shimmer{position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);animation:shimmer 1.5s infinite}
        @keyframes shimmer{to{left:100%}}
        .spinner{width:24px;height:24px;border:3px solid transparent;border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .step-text{font-size:0.9rem;color:var(--muted);margin-left:8px}
        
        .result-container{border-radius:20px;overflow:hidden;background:rgba(0,0,0,0.3);position:relative}
        .result-container canvas{width:100%;aspect-ratio:1;display:block}
        .result-badge{position:absolute;top:12px;left:12px;background:linear-gradient(135deg,#ec4899,#8b5cf6);padding:8px 16px;border-radius:20px;font-size:0.85rem;font-weight:600;z-index:10}
        .result-actions{position:absolute;bottom:12px;left:12px;right:12px;display:flex;gap:10px;z-index:10}
        .result-action-btn{flex:1;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);border:none;padding:12px;border-radius:12px;color:#fff;font-size:0.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px}
        
        .caption-box{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:14px;padding:14px;font-size:0.95rem;margin-bottom:10px}
        .copy-btn{width:100%;padding:14px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;font-size:0.95rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all 0.2s}
        .copy-btn.copied{background:rgba(34,197,94,0.2);border-color:rgba(34,197,94,0.3);color:#4ade80}
        
        .share-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .share-btn{padding:16px;border-radius:14px;font-weight:600;font-size:0.95rem;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;color:#fff;transition:all 0.2s}
        .share-btn:active{transform:scale(0.96)}
        .share-btn.vk{background:#4a76a8}
        .share-btn.telegram{background:#0088cc}
        .share-btn.download{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2)}
        .share-btn.more{background:linear-gradient(135deg,#22c55e,#16a34a)}
        
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(30,27,75,0.95);backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,0.1);padding:8px 0;padding-bottom:max(8px,env(safe-area-inset-bottom));z-index:100}
        .nav-content{display:flex;justify-content:space-around;max-width:500px;margin:0 auto}
        .nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;background:none;border:none;color:var(--muted);font-size:0.7rem;cursor:pointer;padding:10px 24px;border-radius:14px;transition:all 0.2s}
        .nav-item.active{color:var(--primary);background:rgba(236,72,153,0.1)}
        .nav-icon{font-size:1.5rem}
        
        .history-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
        .history-item{position:relative;aspect-ratio:1;border-radius:16px;overflow:hidden;cursor:pointer}
        .history-item img{width:100%;height:100%;object-fit:cover}
        
        .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
        .stat-card{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:20px;text-align:center}
        .stat-value{font-size:1.8rem;font-weight:700}
        .stat-value.pink{color:var(--primary)}
        .stat-value.red{color:#f87171}
        .stat-value.blue{color:#60a5fa}
        .stat-label{font-size:0.8rem;color:var(--muted);margin-top:4px}
        
        .profile-card{background:linear-gradient(135deg,rgba(236,72,153,0.2),rgba(139,92,246,0.2));border:1px solid rgba(255,255,255,0.1);border-radius:24px;padding:24px;margin-bottom:16px}
        .profile-header{display:flex;align-items:center;gap:16px}
        .profile-avatar{width:70px;height:70px;background:linear-gradient(135deg,#ec4899,#8b5cf6);border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:2rem}
        .profile-info h2{font-size:1.3rem}
        .profile-level{color:var(--muted);font-size:0.85rem}
        .profile-xp{color:#fbbf24;font-weight:600;margin-top:4px}
        
        .achievements-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
        .achievement{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:12px 8px;text-align:center;opacity:0.4}
        .achievement.unlocked{opacity:1;background:rgba(251,191,36,0.1);border-color:rgba(251,191,36,0.3)}
        .achievement-icon{font-size:1.4rem}
        .achievement-name{font-size:0.6rem;margin-top:4px}
        
        .achievement-popup{position:fixed;top:80px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#fbbf24,#f59e0b);padding:14px 24px;border-radius:18px;display:flex;align-items:center;gap:14px;z-index:200;box-shadow:0 10px 40px rgba(251,191,36,0.5);animation:slideDown 0.3s ease-out}
        @keyframes slideDown{from{opacity:0;transform:translate(-50%,-20px)}to{opacity:1;transform:translate(-50%,0)}}
        
        .notice{background:linear-gradient(135deg,rgba(34,197,94,0.15),rgba(16,185,129,0.15));border:1px solid rgba(34,197,94,0.3);border-radius:14px;padding:14px 16px;margin:16px;font-size:0.9rem;display:flex;align-items:center;gap:12px}
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">ü™Ñ</div>
                <div>
                    <div class="logo-text"><h1>–®–∞—Ä–∂–ú–∞—Å—Ç–µ—Ä<span class="badge">PRO</span></h1></div>
                    <div class="level-badge">üëë <span id="levelName">–ù–æ–≤–∏—á–æ–∫</span> ‚Ä¢ –£—Ä. <span id="levelNum">1</span></div>
                </div>
            </div>
            <div class="xp-display"><span id="xpCount">0</span> XP</div>
        </div>
        <div class="xp-bar"><div class="xp-fill" id="xpBar" style="width:0%"></div></div>
    </header>

    <div class="notice">
        <div style="font-size:1.8rem">üé®</div>
        <div><strong>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à–∞—Ä–∂–µ–π!</strong> –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ, —Å—Ç–∏–ª—å –∏ —Å–æ–∑–¥–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —à–∞—Ä–∂ —Å —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏.</div>
    </div>

    <main class="main">
        <div id="createTab">
            <div class="section" id="uploadSection">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-title">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ</div>
                    <div class="upload-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</div>
                    <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
                        <button class="btn btn-primary" onclick="openCamera()">üì∏ –ö–∞–º–µ—Ä–∞</button>
                        <button class="btn btn-secondary" onclick="selectFile()">üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è</button>
                    </div>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display:none">
                <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none">
            </div>

            <div class="section hidden" id="previewSection">
                <div class="preview-container">
                    <div class="preview-label">üë§ –û—Ä–∏–≥–∏–Ω–∞–ª</div>
                    <canvas id="previewCanvas"></canvas>
                    <button class="preview-close" onclick="resetApp()">‚úï</button>
                </div>
            </div>

            <div class="section hidden" id="styleSection">
                <div class="section-title" style="margin-bottom:12px">üé® –°—Ç–∏–ª—å —à–∞—Ä–∂–∞</div>
                <div class="styles-scroll" id="stylesScroll"></div>
            </div>

            <div class="section hidden" id="intensitySection">
                <div class="slider-header">
                    <div class="section-title">üéöÔ∏è –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å</div>
                    <div class="slider-value"><span id="intensityValue">50</span>%</div>
                </div>
                <input type="range" class="slider" id="intensitySlider" min="10" max="100" value="50">
                <div class="slider-labels"><span>–ù–µ–∂–Ω—ã–π</span><span>–Ø—Ä–∫–∏–π</span><span>–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–π</span></div>
            </div>

            <div class="section hidden" id="generateSection">
                <button class="generate-btn" id="generateBtn">
                    <div class="shimmer"></div>
                    <span>‚ú®</span><span>–°–æ–∑–¥–∞—Ç—å —à–∞—Ä–∂</span>
                </button>
                <div class="hidden" id="stepsIndicator" style="display:flex;align-items:center;justify-content:center;margin-top:12px">
                    <div class="spinner"></div>
                    <span class="step-text" id="stepText">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...</span>
                </div>
            </div>

            <div class="section hidden" id="resultSection">
                <div class="result-container">
                    <div class="result-badge">‚ú® –ì–æ—Ç–æ–≤–æ!</div>
                    <canvas id="resultCanvas"></canvas>
                    <div class="result-actions">
                        <button class="result-action-btn" onclick="likeResult()"><span id="heartIcon">ü§ç</span> <span id="likeCount">0</span></button>
                        <button class="result-action-btn" onclick="generateAgain()">üîÑ –ï—â—ë</button>
                    </div>
                </div>
            </div>

            <div class="section hidden" id="captionSection">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                    <div class="section-title">üìù –ü–æ–¥–ø–∏—Å—å</div>
                    <button onclick="changeCaption()" style="background:none;border:none;color:var(--primary);cursor:pointer;font-size:0.9rem">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                </div>
                <div class="caption-box" id="captionText">–°–º–æ—Ç—Ä–∏—Ç–µ, –∫–∞–∫–æ–π —à–∞—Ä–∂! üòÇ #—à–∞—Ä–∂</div>
                <button class="copy-btn" id="copyBtn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>

            <div class="section hidden" id="shareSection">
                <div class="section-title" style="margin-bottom:12px">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</div>
                <div class="share-grid">
                    <button class="share-btn vk" onclick="shareVK()">üí¨ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ</button>
                    <button class="share-btn telegram" onclick="shareTelegram()">‚úàÔ∏è Telegram</button>
                    <button class="share-btn download" onclick="downloadImage()">üíæ –°–∫–∞—á–∞—Ç—å</button>
                    <button class="share-btn more" onclick="shareMore()">üì§ –ï—â—ë</button>
                </div>
            </div>
        </div>

        <div id="historyTab" class="hidden">
            <div class="section">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                    <h2 style="font-size:1.3rem">üìú –ò—Å—Ç–æ—Ä–∏—è</h2>
                    <span style="color:var(--muted)"><span id="historyCount">0</span> —à–∞—Ä–∂–µ–π</span>
                </div>
                <div class="history-grid" id="historyGrid"></div>
                <div id="emptyHistory" style="text-align:center;padding:60px 20px;color:var(--muted)">
                    <div style="font-size:3rem;margin-bottom:16px">üì≠</div>
                    <div>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>
                </div>
            </div>
        </div>

        <div id="profileTab" class="hidden">
            <div class="section">
                <div class="profile-card">
                    <div class="profile-header">
                        <div class="profile-avatar">üëë</div>
                        <div class="profile-info">
                            <h2 id="profileLevelName">–ù–æ–≤–∏—á–æ–∫</h2>
                            <div class="profile-level">–£—Ä–æ–≤–µ–Ω—å <span id="profileLevel">1</span></div>
                            <div class="profile-xp">‚ö° <span id="profileXP">0</span> XP</div>
                        </div>
                    </div>
                    <div class="xp-bar" style="margin-top:16px"><div class="xp-fill" id="profileXPBar" style="width:0%"></div></div>
                </div>
                <div class="stats-grid" style="margin-bottom:16px">
                    <div class="stat-card"><div class="stat-value pink" id="statCreated">0</div><div class="stat-label">–°–æ–∑–¥–∞–Ω–æ</div></div>
                    <div class="stat-card"><div class="stat-value red" id="statLikes">0</div><div class="stat-label">–õ–∞–π–∫–æ–≤</div></div>
                    <div class="stat-card"><div class="stat-value blue" id="statShares">0</div><div class="stat-label">–†–µ–ø–æ—Å—Ç–æ–≤</div></div>
                </div>
                <div class="section-title" style="margin-bottom:12px">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
                <div class="achievements-grid" id="achievementsGrid"></div>
            </div>
        </div>
    </main>

    <nav class="bottom-nav">
        <div class="nav-content">
            <button class="nav-item active" id="navCreate"><span class="nav-icon">ü™Ñ</span><span>–°–æ–∑–¥–∞—Ç—å</span></button>
            <button class="nav-item" id="navHistory"><span class="nav-icon">üìú</span><span>–ò—Å—Ç–æ—Ä–∏—è</span></button>
            <button class="nav-item" id="navProfile"><span class="nav-icon">üèÜ</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
        </div>
    </nav>

    <div class="achievement-popup hidden" id="achievementPopup">
        <div style="font-size:2rem">üèÜ</div>
        <div><div style="font-weight:700">–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ!</div><div id="achievementName"></div></div>
    </div>

    <script>
        // === DATA ===
        const STYLES = [
            {id:'funny',emoji:'üòÇ',name:'–°–º–µ—à–Ω–æ–π',effect:'caricature'},
            {id:'cartoon',emoji:'üé®',name:'–ú—É–ª—å—Ç—è—à–Ω—ã–π',effect:'posterize'},
            {id:'anime',emoji:'üå∏',name:'–ê–Ω–∏–º–µ',effect:'anime'},
            {id:'sketch',emoji:'‚úèÔ∏è',name:'–°–∫–µ—Ç—á',effect:'sketch'},
            {id:'comic',emoji:'üí•',name:'–ö–æ–º–∏–∫—Å',effect:'comic'},
            {id:'chibi',emoji:'üß∏',name:'–ß–∏–±–∏',effect:'chibi'},
            {id:'artistic',emoji:'üñºÔ∏è',name:'–•—É–¥–æ–∂–µ—Å—Ç–≤.',effect:'artistic'},
            {id:'celebrity',emoji:'‚≠ê',name:'–ó–≤—ë–∑–¥–Ω—ã–π',effect:'glamour'},
            {id:'pixel',emoji:'üëæ',name:'–ü–∏–∫—Å–µ–ª—å–Ω—ã–π',effect:'pixel'},
            {id:'watercolor',emoji:'üé®',name:'–ê–∫–≤–∞—Ä–µ–ª—å',effect:'watercolor'},
            {id:'grotesque',emoji:'üëπ',name:'–ì—Ä–æ—Ç–µ—Å–∫',effect:'grotesque'},
            {id:'vintage',emoji:'üì∑',name:'–í–∏–Ω—Ç–∞–∂',effect:'vintage'},
        ];
        const CAPTIONS = ['–°–º–æ—Ç—Ä–∏—Ç–µ, –∫–∞–∫–æ–π —à–∞—Ä–∂! üòÇ #—à–∞—Ä–∂ #–∫–∞—Ä–∏–∫–∞—Ç—É—Ä–∞','AI —Å–æ–∑–¥–∞–ª –º–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç! ü§ñ‚ú® #AIart','–ù–µ–º–Ω–æ–≥–æ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞ üé® #—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ','–û—Ü–µ–Ω–∏—Ç–µ –æ—Ç 1 –¥–æ 10 üëá #–æ–ø—Ä–æ—Å','–õ–æ–≤–∏—Ç–µ –ø–æ–∑–∏—Ç–∏–≤! üåü‚ù§Ô∏è','–ú–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç –≤ —Å—Ç–∏–ª–µ —à–∞—Ä–∂! üé®'];
        const ACHIEVEMENTS = [{id:'first',emoji:'üéØ',name:'–ü–µ—Ä–≤—ã–π —à–∞–≥'},{id:'creative',emoji:'üé®',name:'–¢–≤–æ—Ä–µ—Ü'},{id:'popular',emoji:'‚≠ê',name:'–ü–æ–ø—É–ª—è—Ä–Ω—ã–π'},{id:'viral',emoji:'üî•',name:'–í–∏—Ä—É—Å–Ω—ã–π'},{id:'master',emoji:'üëë',name:'–ú–∞—Å—Ç–µ—Ä'}];
        const LEVELS = ['–ù–æ–≤–∏—á–æ–∫','–£—á–µ–Ω–∏–∫','–ü–æ–¥–º–∞—Å—Ç–µ—Ä—å–µ','–ú–∞—Å—Ç–µ—Ä','–≠–∫—Å–ø–µ—Ä—Ç','–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª','–í–∏—Ä—Ç—É–æ–∑','–ì–µ–Ω–∏–π','–õ–µ–≥–µ–Ω–¥–∞','–ë–æ–≥'];
        const LEVEL_XP = [0,100,300,600,1000,1500,2200,3000,4000,5500,7500];

        // === STATE ===
        let state = {style:'funny',intensity:50,img:null,result:null,likes:0,stats:{created:0,likes:0,shares:0,xp:0,level:1,achievements:[]},history:[]};

        // === INIT ===
        function init(){
            loadState();
            renderStyles();
            renderAchievements();
            updateUI();
            setupEvents();
        }

        function loadState(){
            try{
                const s = localStorage.getItem('sharzh_stats');
                const h = localStorage.getItem('sharzh_history');
                if(s) state.stats = JSON.parse(s);
                if(h) state.history = JSON.parse(h);
            }catch(e){}
        }

        function saveState(){
            localStorage.setItem('sharzh_stats',JSON.stringify(state.stats));
            localStorage.setItem('sharzh_history',JSON.stringify(state.history));
        }

        function updateUI(){
            const l = state.stats.level;
            document.getElementById('levelName').textContent = LEVELS[Math.min(l-1,LEVELS.length-1)];
            document.getElementById('levelNum').textContent = l;
            document.getElementById('xpCount').textContent = state.stats.xp;
            const progress = ((state.stats.xp - (LEVEL_XP[l-1]||0)) / ((LEVEL_XP[l]||10000) - (LEVEL_XP[l-1]||0))) * 100;
            document.getElementById('xpBar').style.width = Math.max(0,Math.min(100,progress)) + '%';
            document.getElementById('profileLevelName').textContent = LEVELS[Math.min(l-1,LEVELS.length-1)];
            document.getElementById('profileLevel').textContent = l;
            document.getElementById('profileXP').textContent = state.stats.xp;
            document.getElementById('profileXPBar').style.width = Math.max(0,Math.min(100,progress)) + '%';
            document.getElementById('statCreated').textContent = state.stats.created;
            document.getElementById('statLikes').textContent = state.stats.likes;
            document.getElementById('statShares').textContent = state.stats.shares;
            document.getElementById('historyCount').textContent = state.history.length;
            document.getElementById('emptyHistory').classList.toggle('hidden',state.history.length>0);
            renderHistory();
        }

        function renderStyles(){
            document.getElementById('stylesScroll').innerHTML = STYLES.map(s=>
                `<div class="style-card ${s.id===state.style?'active':''}" data-style="${s.id}">
                    <span class="style-emoji">${s.emoji}</span>
                    <span class="style-name">${s.name}</span>
                </div>`
            ).join('');
            document.querySelectorAll('.style-card').forEach(c=>{
                c.onclick = ()=>{state.style=c.dataset.style;renderStyles()};
            });
        }

        function renderAchievements(){
            document.getElementById('achievementsGrid').innerHTML = ACHIEVEMENTS.map(a=>
                `<div class="achievement ${state.stats.achievements.includes(a.id)?'unlocked':''}">
                    <div class="achievement-icon">${a.emoji}</div>
                    <div class="achievement-name">${a.name}</div>
                </div>`
            ).join('');
        }

        function renderHistory(){
            document.getElementById('historyGrid').innerHTML = state.history.map(item=>
                `<div class="history-item"><img src="${item.image}" alt="History"></div>`
            ).join('');
        }

        function setupEvents(){
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const cameraInput = document.getElementById('cameraInput');
            const slider = document.getElementById('intensitySlider');
            const generateBtn = document.getElementById('generateBtn');

            uploadArea.ondragover = e=>{e.preventDefault();uploadArea.classList.add('dragover')};
            uploadArea.ondragleave = ()=>uploadArea.classList.remove('dragover');
            uploadArea.ondrop = e=>{e.preventDefault();uploadArea.classList.remove('dragover');handleFile(e.dataTransfer.files[0])};
            uploadArea.onclick = e=>{if(e.target.tagName!=='BUTTON')selectFile()};
            
            fileInput.onchange = e=>handleFile(e.target.files[0]);
            cameraInput.onchange = e=>handleFile(e.target.files[0]);
            slider.oninput = e=>{state.intensity=+e.target.value;document.getElementById('intensityValue').textContent=state.intensity};
            generateBtn.onclick = generate;

            document.getElementById('navCreate').onclick = ()=>switchTab('create');
            document.getElementById('navHistory').onclick = ()=>switchTab('history');
            document.getElementById('navProfile').onclick = ()=>switchTab('profile');
        }

        function selectFile(){document.getElementById('fileInput').click()}
        function openCamera(){document.getElementById('cameraInput').click()}

        function handleFile(file){
            if(!file||!file.type.startsWith('image/'))return;
            if(file.size>15*1024*1024){alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 15 –ú–ë)');return}
            const reader = new FileReader();
            reader.onload = e=>{
                state.img = new Image();
                state.img.onload = ()=>{
                    const canvas = document.getElementById('previewCanvas');
                    canvas.width = 512;
                    canvas.height = 512;
                    const ctx = canvas.getContext('2d');
                    drawImageCover(ctx,state.img,512,512);
                    showEditor();
                };
                state.img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function drawImageCover(ctx,img,w,h){
            const scale = Math.max(w/img.width,h/img.height);
            const x = (w-img.width*scale)/2;
            const y = (h-img.height*scale)/2;
            ctx.drawImage(img,x,y,img.width*scale,img.height*scale);
        }

        function showEditor(){
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('previewSection').classList.remove('hidden');
            document.getElementById('styleSection').classList.remove('hidden');
            document.getElementById('intensitySection').classList.remove('hidden');
            document.getElementById('generateSection').classList.remove('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('captionSection').classList.add('hidden');
            document.getElementById('shareSection').classList.add('hidden');
        }

        function resetApp(){
            state.img = null;
            state.result = null;
            state.likes = 0;
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('previewSection').classList.add('hidden');
            document.getElementById('styleSection').classList.add('hidden');
            document.getElementById('intensitySection').classList.add('hidden');
            document.getElementById('generateSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('captionSection').classList.add('hidden');
            document.getElementById('shareSection').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            document.getElementById('cameraInput').value = '';
        }

        async function generate(){
            if(!state.img)return;
            
            const btn = document.getElementById('generateBtn');
            const steps = document.getElementById('stepsIndicator');
            const stepText = document.getElementById('stepText');
            
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div><span>–°–æ–∑–¥–∞—ë–º...</span>';
            steps.classList.remove('hidden');

            const stepNames = ['üì∑ –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ...','üîç –í—ã–¥–µ–ª–µ–Ω–∏–µ —á–µ—Ä—Ç...','üé® –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∏–ª—è...','‚ú® –°–æ–∑–¥–∞–Ω–∏–µ —à–∞—Ä–∂–∞...'];
            for(let i=0;i<stepNames.length;i++){
                stepText.textContent = stepNames[i];
                await sleep(350+Math.random()*200);
            }

            // Create result
            const canvas = document.getElementById('resultCanvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            // Draw base image
            drawImageCover(ctx,state.img,512,512);
            
            // Apply effect based on style
            const style = STYLES.find(s=>s.id===state.style);
            const intensity = state.intensity/50;
            
            applyEffect(ctx,canvas,style?.effect||'caricature',intensity);

            state.result = canvas.toDataURL('image/png');
            
            // Show result
            document.getElementById('resultSection').classList.remove('hidden');
            document.getElementById('captionSection').classList.remove('hidden');
            document.getElementById('shareSection').classList.remove('hidden');
            
            // Update stats
            state.stats.created++;
            state.stats.xp += 25;
            updateLevel();
            checkAchievements();
            
            // Add to history
            state.history.unshift({image:state.result,style:state.style,date:Date.now()});
            if(state.history.length>30)state.history.pop();
            
            saveState();
            updateUI();
            
            // Reset button
            btn.disabled = false;
            btn.innerHTML = '<div class="shimmer"></div><span>‚ú®</span><span>–°–æ–∑–¥–∞—Ç—å —à–∞—Ä–∂</span>';
            steps.classList.add('hidden');
            
            // Set caption
            const styleName = STYLES.find(s=>s.id===state.style)?.name||'';
            document.getElementById('captionText').textContent = `–ú–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç –≤ —Å—Ç–∏–ª–µ "${styleName}"! üé® ${CAPTIONS[Math.floor(Math.random()*CAPTIONS.length)]}`;
        }

        function applyEffect(ctx,canvas,effect,intensity){
            const imageData = ctx.getImageData(0,0,512,512);
            const data = imageData.data;
            const w = 512, h = 512;

            switch(effect){
                case 'caricature':
                    // Funny distortion + color boost
                    ctx.putImageData(imageData,0,0);
                    ctx.filter = `saturate(${1.6*intensity}) contrast(${1.3*intensity}) hue-rotate(${15*intensity}deg)`;
                    ctx.drawImage(canvas,0,0);
                    ctx.filter = 'none';
                    // Add bulge effect simulation
                    bulgeEffect(ctx,canvas,w/2,h/2,150,0.15*intensity);
                    break;
                    
                case 'posterize':
                    // Cartoon posterize effect
                    ctx.putImageData(imageData,0,0);
                    ctx.filter = `saturate(${1.8*intensity}) contrast(${1.5*intensity}) brightness(1.1)`;
                    ctx.drawImage(canvas,0,0);
                    ctx.filter = 'none';
                    posterize(ctx,canvas,Math.max(4,Math.floor(12-intensity*6)));
                    break;
                    
                case 'anime':
                    // Anime style with smooth colors
                    ctx.putImageData(imageData,0,0);
                    ctx.filter = `saturate(${1.5*intensity}) brightness(${1.15*intensity}) contrast(${1.2*intensity})`;
                    ctx.drawImage(canvas,0,0);
                    ctx.filter = 'none';
                    ctx.globalCompositeOperation = 'soft-light';
                    ctx.fillStyle = `rgba(255,180,220,${0.3*intensity})`;
                    ctx.fillRect(0,0,w,h);
                    ctx.globalCompositeOperation = 'source-over';
                    break;
                    
                case 'sketch':
                    // Pencil sketch effect
                    ctx.putImageData(imageData,0,0);
                    ctx.filter = `grayscale(${0.9*intensity}) contrast(${1.6*intensity}) brightness(1.1)`;
                    ctx.drawImage(canvas,0,0);
                    ctx.filter = 'none';
                    // Edge detection simulation
                    edgeDetect(ctx,canvas,intensity);
                    break;
                    
                case 'comic':
                    // Comic book style
                    ctx.putImageData(imageData,0,0);
                    ctx.filter = `saturate(${2*intensity}) contrast(${1.7*intensity})`;
                    ctx.drawImage(canvas,0,0);
                    ctx.filter = 'none';
                    posterize(ctx,canvas,Math.max(3,Math.floor(8-intensity*4)));
                    ctx.globalCompositeOperation = 'multiply';
                    ctx.fillStyle = `rgba(255,80,30,${0.15*intensity})`;
                    ctx.fillRect(0,0,w,h);
                    ctx.globalCompositeOperation = 'source-over';
                    break;
                    
                case 'chibi':
                    // Cute chibi style
                    ctx.putImageData(imageData,0,0);
                    ctx.filter = `saturate(${1.8*intensity}) brightness(${1.2*intensity})`;
                    ctx.drawImage(canvas,0,0);
                    ctx.filter = 'none';
                    bulgeEffect(ctx,canvas,w/2,h*0.4,200,0.2*intensity);
                    ctx.globalCompositeOperation = 'soft-light';
                    ctx.fillStyle = `rgba(255,200,220,${0.35*intensity})`;
                    ctx.fillRect(0,0,w,h);
                    ctx.globalCompositeOperation = 'source-over';
                    break;
                    
                case 'artistic':
                    // Artistic painterly style
                    ctx.putImageData(imageData,0,0);
                    ctx.filter = `saturate(${1.3*intensity}) brightness(${1.1*intensity})`;
                    ctx.drawImage(canvas,0,0);
                    ctx.filter = 'none';
                    ctx.globalCompositeOperation = 'overlay';
                    ctx.fillStyle = `rgba(255,220,180,${0.25*intensity})`;
                    ctx.fillRect(0,0,w,h);
                    ctx.globalCompositeOperation = 'source-over';
                    // Add brush texture
                    addBrushTexture(ctx,w,h,intensity*0.3);
                    break;
                    
                case 'glamour':
                    // Celebrity glamour
                    ctx.putImageData(imageData,0,0);
                    ctx.filter = `saturate(${1.3*intensity}) brightness(${1.1*intensity}) contrast(${1.15*intensity})`;
                    ctx.drawImage(canvas,0,0);
                    ctx.filter = 'none';
                    ctx.globalCompositeOperation = 'overlay';
                    ctx.fillStyle = `rgba(255,215,0,${0.2*intensity})`;
                    ctx.fillRect(0,0,w,h);
                    ctx.globalCompositeOperation = 'source-over';
                    // Add glow
                    addGlow(ctx,canvas,intensity*0.4);
                    break;
                    
                case 'pixel':
                    // Pixel art style
                    const pixelSize = Math.max(3,Math.floor(20-intensity*12));
                    const tempC = document.createElement('canvas');
                    tempC.width = w/pixelSize;
                    tempC.height = h/pixelSize;
                    const tempCtx = tempC.getContext('2d');
                    tempCtx.imageSmoothingEnabled = false;
                    tempCtx.drawImage(canvas,0,0,tempC.width,tempC.height);
                    ctx.imageSmoothingEnabled = false;
                    ctx.drawImage(tempC,0,0,w,h);
                    ctx.imageSmoothingEnabled = true;
                    break;
                    
                case 'watercolor':
                    // Watercolor painting
                    ctx.putImageData(imageData,0,0);
                    ctx.filter = `saturate(${1.4*intensity}) brightness(${1.08*intensity})`;
                    ctx.drawImage(canvas,0,0);
                    ctx.filter = 'blur(1px)';
                    ctx.globalAlpha = 0.4;
                    ctx.drawImage(canvas,0,0);
                    ctx.filter = 'none';
                    ctx.globalAlpha = 1;
                    ctx.globalCompositeOperation = 'soft-light';
                    ctx.fillStyle = `rgba(150,200,255,${0.25*intensity})`;
                    ctx.fillRect(0,0,w,h);
                    ctx.globalCompositeOperation = 'source-over';
                    addWatercolorTexture(ctx,w,h,intensity*0.3);
                    break;
                    
                case 'grotesque':
                    // Grotesque distortion
                    ctx.putImageData(imageData,0,0);
                    ctx.filter = `saturate(${1.6*intensity}) contrast(${1.9*intensity}) hue-rotate(${40*intensity}deg)`;
                    ctx.drawImage(canvas,0,0);
                    ctx.filter = 'none';
                    // Strong distortion
                    distortEffect(ctx,canvas,intensity*0.3);
                    ctx.globalCompositeOperation = 'overlay';
                    ctx.fillStyle = `rgba(100,0,50,${0.25*intensity})`;
                    ctx.fillRect(0,0,w,h);
                    ctx.globalCompositeOperation = 'source-over';
                    break;
                    
                case 'vintage':
                    // Vintage photo
                    ctx.putImageData(imageData,0,0);
                    ctx.filter = `sepia(${0.6*intensity}) contrast(${1.2*intensity}) brightness(1.05)`;
                    ctx.drawImage(canvas,0,0);
                    ctx.filter = 'none';
                    ctx.globalCompositeOperation = 'overlay';
                    ctx.fillStyle = `rgba(180,150,100,${0.2*intensity})`;
                    ctx.fillRect(0,0,w,h);
                    ctx.globalCompositeOperation = 'source-over';
                    // Add vignette
                    addVignette(ctx,w,h,intensity*0.5);
                    break;
            }
        }

        // Helper functions
        function sleep(ms){return new Promise(r=>setTimeout(r,ms))}

        function bulgeEffect(ctx,canvas,cx,cy,radius,strength){
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas,0,0);
            
            const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
            const data = imgData.data;
            const srcData = tempCtx.getImageData(0,0,canvas.width,canvas.height).data;
            const w = canvas.width, h = canvas.height;
            
            for(let y=0;y<h;y++){
                for(let x=0;x<w;x++){
                    const dx = x-cx;
                    const dy = y-cy;
                    const dist = Math.sqrt(dx*dx+dy*dy);
                    
                    if(dist<radius){
                        const factor = 1 - strength * Math.pow(1-dist/radius,2);
                        let srcX = Math.round(cx + dx*factor);
                        let srcY = Math.round(cy + dy*factor);
                        srcX = Math.max(0,Math.min(w-1,srcX));
                        srcY = Math.max(0,Math.min(h-1,srcY));
                        
                        const dstIdx = (y*w+x)*4;
                        const srcIdx = (srcY*w+srcX)*4;
                        
                        data[dstIdx] = srcData[srcIdx];
                        data[dstIdx+1] = srcData[srcIdx+1];
                        data[dstIdx+2] = srcData[srcIdx+2];
                    }
                }
            }
            ctx.putImageData(imgData,0,0);
        }

        function posterize(ctx,canvas,levels){
            const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
            const data = imgData.data;
            const step = 255/levels;
            
            for(let i=0;i<data.length;i+=4){
                data[i] = Math.round(data[i]/step)*step;
                data[i+1] = Math.round(data[i+1]/step)*step;
                data[i+2] = Math.round(data[i+2]/step)*step;
            }
            ctx.putImageData(imgData,0,0);
        }

        function edgeDetect(ctx,canvas,intensity){
            const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
            const data = imgData.data;
            const w = canvas.width;
            
            for(let y=1;y<canvas.height-1;y++){
                for(let x=1;x<w-1;x++){
                    const idx = (y*w+x)*4;
                    const idxLeft = (y*w+x-1)*4;
                    const idxRight = (y*w+x+1)*4;
                    const idxTop = ((y-1)*w+x)*4;
                    const idxBottom = ((y+1)*w+x)*4;
                    
                    const edge = Math.abs(data[idx]-data[idxLeft]) + 
                                 Math.abs(data[idx]-data[idxRight]) +
                                 Math.abs(data[idx]-data[idxTop]) +
                                 Math.abs(data[idx]-data[idxBottom]);
                    
                    if(edge > 50){
                        data[idx] = Math.min(255, data[idx] + edge*intensity*0.5);
                        data[idx+1] = Math.min(255, data[idx+1] + edge*intensity*0.5);
                        data[idx+2] = Math.min(255, data[idx+2] + edge*intensity*0.5);
                    }
                }
            }
            ctx.putImageData(imgData,0,0);
        }

        function distortEffect(ctx,canvas,strength){
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas,0,0);
            
            const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
            const data = imgData.data;
            const srcData = tempCtx.getImageData(0,0,canvas.width,canvas.height).data;
            const w = canvas.width, h = canvas.height;
            
            for(let y=0;y<h;y++){
                for(let x=0;x<w;x++){
                    const wave = Math.sin(x*0.05)*strength*20 + Math.cos(y*0.05)*strength*20;
                    let srcX = Math.round(x + wave);
                    let srcY = Math.round(y + wave);
                    srcX = Math.max(0,Math.min(w-1,srcX));
                    srcY = Math.max(0,Math.min(h-1,srcY));
                    
                    const dstIdx = (y*w+x)*4;
                    const srcIdx = (srcY*w+srcX)*4;
                    
                    data[dstIdx] = srcData[srcIdx];
                    data[dstIdx+1] = srcData[srcIdx+1];
                    data[dstIdx+2] = srcData[srcIdx+2];
                }
            }
            ctx.putImageData(imgData,0,0);
        }

        function addBrushTexture(ctx,w,h,intensity){
            for(let i=0;i<200*intensity;i++){
                const x = Math.random()*w;
                const y = Math.random()*h;
                const size = Math.random()*3+1;
                ctx.fillStyle = `rgba(${Math.random()*100+100},${Math.random()*100+100},${Math.random()*100+100},${Math.random()*0.1})`;
                ctx.beginPath();
                ctx.arc(x,y,size,0,Math.PI*2);
                ctx.fill();
            }
        }

        function addGlow(ctx,canvas,intensity){
            ctx.globalCompositeOperation = 'soft-light';
            ctx.filter = `blur(${20*intensity}px)`;
            ctx.globalAlpha = 0.3*intensity;
            ctx.drawImage(canvas,0,0);
            ctx.filter = 'none';
            ctx.globalAlpha = 1;
            ctx.globalCompositeOperation = 'source-over';
        }

        function addWatercolorTexture(ctx,w,h,intensity){
            ctx.strokeStyle = `rgba(200,220,255,${0.1*intensity})`;
            ctx.lineWidth = 1;
            for(let i=0;i<100*intensity;i++){
                ctx.beginPath();
                ctx.moveTo(Math.random()*w,Math.random()*h);
                ctx.bezierCurveTo(
                    Math.random()*w,Math.random()*h,
                    Math.random()*w,Math.random()*h,
                    Math.random()*w,Math.random()*h
                );
                ctx.stroke();
            }
        }

        function addVignette(ctx,w,h,intensity){
            const gradient = ctx.createRadialGradient(w/2,h/2,0,w/2,h/2,Math.max(w,h)/1.5);
            gradient.addColorStop(0,'transparent');
            gradient.addColorStop(1,`rgba(0,0,0,${0.6*intensity})`);
            ctx.fillStyle = gradient;
            ctx.fillRect(0,0,w,h);
        }

        function generateAgain(){generate()}

        function likeResult(){
            state.likes++;
            state.stats.likes++;
            state.stats.xp += 5;
            document.getElementById('heartIcon').textContent = '‚ù§Ô∏è';
            document.getElementById('likeCount').textContent = state.likes;
            updateLevel();
            saveState();
            updateUI();
        }

        function updateLevel(){
            for(let i=LEVEL_XP.length-1;i>=0;i--){
                if(state.stats.xp >= LEVEL_XP[i]){
                    state.stats.level = i+1;
                    break;
                }
            }
        }

        function checkAchievements(){
            const newA = [];
            if(state.stats.created>=1 && !state.stats.achievements.includes('first'))newA.push('first');
            if(state.stats.created>=10 && !state.stats.achievements.includes('creative'))newA.push('creative');
            if(state.stats.likes>=10 && !state.stats.achievements.includes('popular'))newA.push('popular');
            if(state.stats.shares>=5 && !state.stats.achievements.includes('viral'))newA.push('viral');
            if(state.stats.created>=50 && !state.stats.achievements.includes('master'))newA.push('master');
            
            if(newA.length>0){
                state.stats.achievements.push(...newA);
                const a = ACHIEVEMENTS.find(x=>x.id===newA[0]);
                if(a)showAchievement(a.name);
                renderAchievements();
            }
        }

        function showAchievement(name){
            document.getElementById('achievementName').textContent = name;
            const popup = document.getElementById('achievementPopup');
            popup.classList.remove('hidden');
            setTimeout(()=>popup.classList.add('hidden'),3000);
        }

        function changeCaption(){
            document.getElementById('captionText').textContent = CAPTIONS[Math.floor(Math.random()*CAPTIONS.length)];
        }

        function copyCaption(){
            navigator.clipboard.writeText(document.getElementById('captionText').textContent).then(()=>{
                const btn = document.getElementById('copyBtn');
                btn.classList.add('copied');
                btn.innerHTML = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(()=>{btn.classList.remove('copied');btn.innerHTML='üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'},2000);
            });
        }

        function shareVK(){
            const text = encodeURIComponent(document.getElementById('captionText').textContent);
            window.open(`https://vk.com/share.php?comment=${text}`,'_blank','width=600,height=400');
            state.stats.shares++;
            state.stats.xp += 15;
            saveState();
            updateUI();
        }

        function shareTelegram(){
            const text = encodeURIComponent(document.getElementById('captionText').textContent);
            window.open(`https://t.me/share/url?text=${text}`,'_blank','width=600,height=400');
            state.stats.shares++;
            state.stats.xp += 15;
            saveState();
            updateUI();
        }

        function downloadImage(){
            if(!state.result)return;
            const link = document.createElement('a');
            link.href = state.result;
            link.download = `sharzh_${Date.now()}.png`;
            link.click();
        }

        function shareMore(){
            if(navigator.share){
                navigator.share({title:'–ú–æ–π —à–∞—Ä–∂',text:document.getElementById('captionText').textContent});
            }
        }

        function switchTab(tab){
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
            document.getElementById('nav'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('active');
            document.getElementById('createTab').classList.toggle('hidden',tab!=='create');
            document.getElementById('historyTab').classList.toggle('hidden',tab!=='history');
            document.getElementById('profileTab').classList.toggle('hidden',tab!=='profile');
        }

        init();
    </script>
</body>
</html>
